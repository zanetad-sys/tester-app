import json
import streamlit as st
import pandas as pd
import requests

st.set_page_config(page_title="Jak se st√°t testerem", page_icon="‚úÖ", layout="wide")

# ---------- SAFE STATE KEYS ----------
if "done" not in st.session_state:
    st.session_state.done = {}

DEFAULT_KEYS = {
    # Basics
    "qa_definition": False, "qa_roles": False, "qa_sdlc": False,
    "qa_types": False, "qa_vv": False, "qa_sevpri": False,
    "tech_web": False, "tech_sql": False, "tech_git": False, "tech_logs": False,
    "tech_http": False, "tech_api": False,
    # Tools
    "tools_jira": False, "tools_testmgmt": False, "tools_postman": False, "tools_soapui": False,
    "tools_curl": False, "tools_git": False,
    "tools_python": False, "tools_playwright": False, "tools_selenium": False, "tools_pytest": False,
    "tools_selide": False, "tools_devtools": False, "tools_logs": False, "tools_cicd": False,
    "tools_db_clients": False, "tools_docker": False, "tools_ide": False, "tools_perf": False,
    # Portfolio
    "projects": False, "readme": False, "cv": False,
}
for k, v in DEFAULT_KEYS.items():
    st.session_state.done.setdefault(k, v)

def percent():
    d = st.session_state.done
    return int(100 * sum(1 for v in d.values() if v) / len(d)) if d else 0

# ---------- MENU ----------
menu = st.sidebar.radio(
    "üìö Navigace",
    ["√övod", "Z√°klady", "N√°stroje", "Portfolio", "Mini kv√≠z", "Timeline", "Zdroje", "üìñ Teorie", "üß≠ QA tah√°k", "üåê API tester"],
    index=0,
)

# ---------- PAGES ----------
def page_uvod():
    st.title("Jak se st√°t testerem ‚Äì mini pr≈Øvodce")
    st.write("Postupnƒõ a v klidu. Z√°klady a praxe. Za≈°krt√°vej splnƒõn√© kroky a sleduj postup.")
    c1, c2 = st.columns([1, 2])
    with c1:
        st.metric("Splnƒõno", f"{percent()} %")
        if st.button("Resetuj postup"):
            for k in st.session_state.done:
                st.session_state.done[k] = False
            st.rerun()
    with c2:
        st.info("Pou≈æ√≠vej menu vlevo. Ka≈æd√° sekce se zobraz√≠ v hlavn√≠ ƒç√°sti.")

def page_zaklady():
    st.header("1) Z√°klady QA ‚Äì kompletn√≠ p≈ôehled")

    st.subheader("üéØ Co je QA a role testera")
    st.session_state.done["qa_definition"] = st.checkbox("Co je testov√°n√≠ / QA", value=st.session_state.done["qa_definition"])
    st.session_state.done["qa_roles"] = st.checkbox("Role: tester vs. v√Ωvoj√°≈ô vs. produkt√°k", value=st.session_state.done["qa_roles"])
    st.session_state.done["qa_sdlc"] = st.checkbox("≈Ωivotn√≠ cyklus v√Ωvoje (SDLC, agiln√≠, waterfall)", value=st.session_state.done["qa_sdlc"])
    st.session_state.done["qa_types"] = st.checkbox("Typy test≈Ø ‚Äì √∫rovnƒõ (unit, integraƒçn√≠, syst√©mov√©, akceptaƒçn√≠)", value=st.session_state.done["qa_types"])
    st.session_state.done["qa_vv"] = st.checkbox("Verifikace vs. Validace", value=st.session_state.done["qa_vv"])
    st.session_state.done["qa_sevpri"] = st.checkbox("Severita vs. priorita bug≈Ø", value=st.session_state.done["qa_sevpri"])

    with st.expander("üìñ Vysvƒõtlivky ‚Äì QA z√°klady"):
        st.markdown(
            "- QA = zaji≈°tƒõn√≠ kvality (procesy + testov√°n√≠)\n"
            "- SDLC = waterfall (f√°ze po sobƒõ) vs. agile (iterace)\n"
            "- Verifikace = dƒõl√°me vƒõci spr√°vnƒõ; Validace = dƒõl√°me spr√°vn√© vƒõci\n"
            "- Severita = dopad chyby; Priorita = rychlost ≈ôe≈°en√≠\n"
        )

    st.divider()

    st.subheader("üñ•Ô∏è Technick√© minimum")
    c1, c2, c3 = st.columns(3)
    with c1:
        st.session_state.done["tech_web"] = st.checkbox("Web (HTML, CSS, JS)", value=st.session_state.done["tech_web"])
        st.session_state.done["tech_sql"] = st.checkbox("Datab√°ze + SQL", value=st.session_state.done["tech_sql"])
    with c2:
        st.session_state.done["tech_git"] = st.checkbox("Git/GitHub", value=st.session_state.done["tech_git"])
        st.session_state.done["tech_logs"] = st.checkbox("Logy (application/system/security)", value=st.session_state.done["tech_logs"])
    with c3:
        st.session_state.done["tech_http"] = st.checkbox("HTTP/HTTPS z√°klady", value=st.session_state.done["tech_http"])
        st.session_state.done["tech_api"] = st.checkbox("API (REST/JSON, SOAP/XML)", value=st.session_state.done["tech_api"])

    with st.expander("üìñ Vysvƒõtlivky ‚Äì Technick√© minimum"):
        st.markdown(
            "- Web = HTML, CSS, JS\n"
            "- SQL = SELECT, JOIN, INSERT, UPDATE\n"
            "- Git = commit, push, pull request\n"
            "- HTTP = request/response, status k√≥dy (200, 404, 500)\n"
            "- API = REST (JSON), SOAP (XML)\n"
        )

    st.divider()

    st.subheader("üõ†Ô∏è Praktick√© n√°stroje")
    st.session_state.done["tools_postman"] = st.checkbox("Postman / SOAP UI", value=st.session_state.done["tools_postman"])
    st.session_state.done["tools_devtools"] = st.checkbox("DevTools (network, console, cookies)", value=st.session_state.done["tools_devtools"])

    st.subheader("ü§ñ Automatizace + Bonus")
    st.session_state.done["auto_python"] = st.checkbox("Z√°klady Pythonu/jin√©ho jazyka", value=st.session_state.done["auto_python"])
    st.session_state.done["auto_framework"] = st.checkbox("Framework (pytest, Playwright, Selenium)", value=st.session_state.done["auto_framework"])
    st.session_state.done["auto_ci"] = st.checkbox("CI/CD (GitHub Actions, GitLab CI)", value=st.session_state.done["auto_ci"])

    # Export checklistu
    items = [k for k in st.session_state.done if k.startswith(("qa_", "tech_", "tools_", "auto_"))]
    st.download_button("‚¨áÔ∏è St√°hnout checklist z√°klad≈Ø", "\\n".join(f"- {k}" for k in items), "qa-zaklady-checklist.txt")

def page_nastroje():
    st.header("2) N√°stroje ‚Äì co by mƒõl tester zn√°t")

    st.subheader("üìÇ Organizace & bug tracking")
    c1, c2 = st.columns(2)
    with c1:
        st.session_state.done["tools_jira"] = st.checkbox("Jira / Trello / Asana / Bugzilla", value=st.session_state.done["tools_jira"])
    with c2:
        st.session_state.done["tools_testmgmt"] = st.checkbox("Test management: TestRail / Xray / Zephyr / Azure DevOps / Sheets", value=st.session_state.done["tools_testmgmt"])

    st.divider()

    st.subheader("üåê API & komunikace")
    c1, c2, c3 = st.columns(3)
    with c1:
        st.session_state.done["tools_postman"] = st.checkbox("Postman ‚Äì kolekce, environmenty, test scripts", value=st.session_state.done["tools_postman"])
    with c2:
        st.session_state.done["tools_soapui"] = st.checkbox("SOAP UI ‚Äì testov√°n√≠ SOAP (XML)", value=st.session_state.done["tools_soapui"])
    with c3:
        st.session_state.done["tools_curl"] = st.checkbox("curl ‚Äì rychl√© vol√°n√≠ API v termin√°lu", value=st.session_state.done["tools_curl"])

    st.divider()

    st.subheader("üîÅ Verzov√°n√≠")
    st.session_state.done["tools_git"] = st.checkbox("Git + GitHub/GitLab/Bitbucket (commity, PR/MR, review)", value=st.session_state.done["tools_git"])

    st.divider()

    st.subheader("ü§ñ Automatizace test≈Ø")
    c1, c2, c3, c4 = st.columns(4)
    with c1:
        st.session_state.done["tools_python"] = st.checkbox("Python / (Java/JS dle firmy)", value=st.session_state.done["tools_python"])
    with c2:
        st.session_state.done["tools_playwright"] = st.checkbox("Playwright (UI testy)", value=st.session_state.done["tools_playwright"])
    with c3:
        st.session_state.done["tools_selenium"] = st.checkbox("Selenium (UI testy)", value=st.session_state.done["tools_selenium"])
    with c4:
        st.session_state.done["tools_pytest"] = st.checkbox("pytest (fixtures, reporty)", value=st.session_state.done["tools_pytest"])
    st.session_state.done["tools_selide"] = st.checkbox("Selenium IDE (rychl√© prototypy)", value=st.session_state.done["tools_selide"])

    st.divider()

    st.subheader("üß∞ DevTools & logy")
    c1, c2 = st.columns(2)
    with c1:
        st.session_state.done["tools_devtools"] = st.checkbox("Chrome/Edge DevTools (Network, Console, Storage, Cookies)", value=st.session_state.done["tools_devtools"])
    with c2:
        st.session_state.done["tools_logs"] = st.checkbox("Logy: application / system / security", value=st.session_state.done["tools_logs"])

    st.divider()

    st.subheader("‚öôÔ∏è CI/CD")
    st.session_state.done["tools_cicd"] = st.checkbox("GitHub Actions / GitLab CI ‚Äì testy po commitu", value=st.session_state.done["tools_cicd"])

    st.divider()

    st.subheader("üóÑÔ∏è Datab√°ze")
    st.session_state.done["tools_db_clients"] = st.checkbox("DBeaver / pgAdmin / MySQL Workbench (GUI pro SQL)", value=st.session_state.done["tools_db_clients"])

    st.divider()

    st.subheader("üß© Dopl≈àkov√©")
    c1, c2, c3 = st.columns(3)
    with c1:
        st.session_state.done["tools_docker"] = st.checkbox("Docker ‚Äì lok√°ln√≠ dev/test prost≈ôed√≠", value=st.session_state.done["tools_docker"])
    with c2:
        st.session_state.done["tools_ide"] = st.checkbox("IDE: VS Code / PyCharm (debugging, linting)", value=st.session_state.done["tools_ide"])
    with c3:
        st.session_state.done["tools_perf"] = st.checkbox("V√Ωkonnostn√≠ testy: JMeter / k6", value=st.session_state.done["tools_perf"])

    chosen = [k for k, v in st.session_state.done.items() if k.startswith("tools_") and v]
    st.download_button("‚¨áÔ∏è St√°hnout checklist n√°stroj≈Ø", "\\n".join(f"- {x}" for x in chosen) if chosen else "Zat√≠m nic neza≈°krtnuto.", "nastroje-checklist.txt")

def page_portfolio():
    st.header("3) Portfolio a pr√°ce")

    st.session_state.done["projects"] = st.checkbox("Miniprojekty na GitHubu", value=st.session_state.done["projects"])
    st.session_state.done["readme"] = st.checkbox("README a uk√°zkov√© bug reporty", value=st.session_state.done["readme"])
    st.session_state.done["cv"] = st.checkbox("CV + LinkedIn ‚Äì zd≈Øraznit praxi", value=st.session_state.done["cv"])

    st.info("Ka≈æd√Ω miniprojekt ukazuje konkr√©tn√≠ skill. Kr√°tk√©, ale ƒçiteln√© README je kl√≠ƒçov√©.")
    st.divider()

    # T√Ωdenn√≠ pl√°n
    with st.form("plan"):
        st.subheader("üó∫Ô∏è T√Ωdenn√≠ pl√°n")
        jmeno = st.text_input("Jm√©no (voliteln√©)", "")
        hodin = st.slider("Kolik hodin t√Ωdnƒõ zvl√°dne≈°?", 1, 20, 5)
        fokus = st.selectbox("Hlavn√≠ fokus na t√Ωden", ["Z√°klady", "API testov√°n√≠", "Automatizace", "Portfolio/README"])
        submit = st.form_submit_button("Vygenerovat pl√°n")
        if submit:
            body = {
                "Z√°klady": ["‚Ä¢ 2 h Git+GitHub", "‚Ä¢ 2 h HTML/CSS/JS", "‚Ä¢ 1 h SQL"],
                "API testov√°n√≠": ["‚Ä¢ 2 h Postman", "‚Ä¢ 2 h requesty", "‚Ä¢ 1 h dokumentace"],
                "Automatizace": ["‚Ä¢ 2 h Python", "‚Ä¢ 2 h Playwright/pytest", "‚Ä¢ 1 h refaktor"],
                "Portfolio/README": ["‚Ä¢ 2 h README", "‚Ä¢ 2 h miniprojekt", "‚Ä¢ 1 h polishing"],
            }
            st.success((f"{jmeno}, " if jmeno else "") + f"tv≈Øj pl√°n na {hodin} h/t√Ωden:")
            st.write("\\n".join(body[fokus]))

    st.divider()

    # Gener√°tor README (download mimo form)
    st.subheader("üß© Gener√°tor README.md pro miniprojekt")
    with st.form("readme_form"):
        proj = st.text_input("N√°zev projektu", "qa-api-tests")
        popis = st.text_area("Kr√°tk√Ω popis", "Sada API test≈Ø pro demo slu≈æbu (REST).")
        technologie = st.text_input("Technologie", "Python, pytest, requests, Postman")
        kroky = st.text_area("Jak spustit", "pip install -r requirements.txt\\npytest -q")
        co_testuju = st.text_area("Co se testuje", "- Smoke testy endpoint≈Ø\\n- Pozitivn√≠/negativn√≠ sc√©n√°≈ôe\\n- Validace status k√≥d≈Ø a JSON schema")
        odkaz = st.text_input("Odkaz (repo / appka)", "https://github.com/uzivatel/qa-api-tests")
        submitted = st.form_submit_button("Vygenerovat README")
        if submitted:
            md = f"# {proj}\\n\\n{popis}\\n\\n## Technologie\\n{technologie}\\n\\n## Jak spustit\\n```
{kroky}
```\\n\\n## Co se testuje\\n{co_testuju}\\n\\n## Odkazy\\n- Repo/App: {odkaz}\\n"
            st.session_state["generated_readme"] = md

    if st.session_state.get("generated_readme"):
        st.code(st.session_state["generated_readme"], language="markdown")
        st.download_button("‚¨áÔ∏è St√°hnout README.md", st.session_state["generated_readme"], file_name="README.md")
        if st.button("Vymazat v√Ωsledek"):
            st.session_state["generated_readme"] = None
            st.rerun()

    st.divider()

    # ≈†ablony
    st.subheader("üìë ≈†ablony do portfolia")
    bug = (
        "N√°zev: [Checkout] 500 p≈ôi pr√°zdn√©m ko≈°√≠ku\\n"
        "Prost≈ôed√≠: test, v1.2.3 (build #456), Chrome 127\\n"
        "Kroky: 1) Otev≈ô√≠t /checkout 2) Kliknout 'Zaplatit' s pr√°zdn√Ωm ko≈°√≠kem\\n"
        "Oƒçek√°van√©: Validace 'Ko≈°√≠k je pr√°zdn√Ω'\\n"
        "Aktu√°ln√≠: HTTP 500, b√≠l√° str√°nka\\n"
        "D≈Økazy: screenshot.png, network.har\\n"
        "Sev/Pri: High / P1  Pozn.: Regrese od v1.2.2\\n"
    )
    tc = (
        "ID: TC-LOGIN-001\\n"
        "C√≠l: P≈ôihl√°≈°en√≠ validn√≠ho u≈æivatele\\n"
        "Kroky: 1) Otev≈ô√≠t /login  2) Vyplnit platn√© √∫daje  3) Odeslat\\n"
        "Oƒçek√°van√©: P≈ôesmƒõrov√°n√≠ na /dashboard\\n"
        "Priorita: P1  Data: user@test.com / *****  Stav: PASS/FAIL\\n"
    )
    st.download_button("‚¨áÔ∏è St√°hnout Bug report (MD)", bug, file_name="bug-report.md")
    st.download_button("‚¨áÔ∏è St√°hnout Test Case (MD)", tc, file_name="test-case.md")

    chosen = [k for k, v in st.session_state.done.items() if k in ("projects", "readme", "cv") and v]
    st.download_button("‚¨áÔ∏è St√°hnout checklist portfolia", "\\n".join(f"- {x}" for x in chosen) if chosen else "Zat√≠m nic neza≈°krtnuto.", "portfolio-checklist.txt")

def page_kviz():
    st.header("üß© Mini kv√≠z")
    odp = st.radio("Co je Pull Request (PR) na GitHubu?", ["P≈ô√≠m√© nahr√°n√≠ k√≥du do main", "N√°vrh zmƒõn z vƒõtve, kter√Ω ostatn√≠ zkontroluj√≠ a slouƒç√≠", "Z√°loha repozit√°≈ôe"])
    if st.button("Vyhodnotit"):
        st.success("Spr√°vnƒõ! üëç" if odp == "N√°vrh zmƒõn z vƒõtve, kter√Ω ostatn√≠ zkontroluj√≠ a slouƒç√≠" else "Je≈°tƒõ jednou: PR je n√°vrh zmƒõn z vƒõtve, kter√Ω se po schv√°len√≠ mergne do main.")

def page_timeline():
    st.header("üóìÔ∏è Doporuƒçen√° timeline")
    st.table(pd.DataFrame({"T√Ωden": ["1", "2", "3", "4"], "Fokus": ["Z√°klady + Git", "API testov√°n√≠", "Automatizace", "Portfolio/README"]}))

def page_zdroje():
    st.header("üìö U≈æiteƒçn√© zdroje ‚Äì kur√°torsk√Ω seznam")
    st.markdown("- Pro Git (kniha): https://git-scm.com/book/en/v2")
    st.markdown("- Postman Learning Center: https://learning.postman.com/")
    st.markdown("- JSONPlaceholder: https://jsonplaceholder.typicode.com/")
    st.markdown("- Swagger Petstore: https://petstore.swagger.io/")
    st.markdown("- MDN Web Docs: https://developer.mozilla.org/")
    st.markdown("- SQLBolt: https://sqlbolt.com/")

    resources_md = (
        "# U≈æiteƒçn√© zdroje (QA starter pack)\\n"
        "- Git & GitHub: Pro Git, PR workflow\\n"
        "- Web: MDN (HTML/CSS/JS)\\n"
        "- SQL: SQLBolt\\n"
        "- API: HTTP status codes, Postman, Swagger Petstore, JSONPlaceholder\\n"
    )
    st.download_button("‚¨áÔ∏è St√°hnout seznam zdroj≈Ø (Markdown)", resources_md, file_name="uzitecne-zdroje.md")

def page_teorie():
    st.header("üìñ Z√°kladn√≠ teorie testov√°n√≠")
    st.markdown("- Typy test≈Ø: Smoke, Regrese, Unit, Integraƒçn√≠, Syst√©mov√©, Akceptaƒçn√≠")
    st.markdown("- Verifikace vs. Validace ‚Äî dƒõl√°me vƒõci spr√°vnƒõ vs. spr√°vn√© vƒõci")
    st.markdown("- Severity vs. Priorita ‚Äî dopad vs. rychlost ≈ôe≈°en√≠")
    st.markdown("- REST/JSON vs. SOAP/XML, HTTP metody a status k√≥dy")
    st.markdown("- SQL: DDL, DML, DQL, DCL; JOIN (INNER/LEFT/RIGHT)")

def page_qatahaky():
    st.header("üß≠ QA tah√°k (proces + ≈°ablony)")
    st.markdown("- P≈ô√≠prava: c√≠l & rozsah, rizika, prost≈ôed√≠ & data, DoD")
    st.markdown("- N√°vrh: ekvivalence, hranice, pairwise; nejd≈ô√≠v smoke")
    st.markdown("- Proveden√≠: scripted + exploratory; evidence PASS/FAIL")
    bug = (
        "N√°zev: [Checkout] 500 p≈ôi pr√°zdn√©m ko≈°√≠ku\\n"
        "Prost≈ôed√≠: test, v1.2.3, Chrome\\n"
        "Kroky: 1) Otev≈ô√≠t /checkout 2) Kliknout 'Zaplatit' s pr√°zdn√Ωm ko≈°√≠kem\\n"
        "Oƒçek√°van√©: Validace 'Ko≈°√≠k je pr√°zdn√Ω'\\n"
    )
    st.download_button("‚¨áÔ∏è St√°hnout Bug report", bug, file_name="bug-report.md")

def page_api_tester():
    st.header("üåê API dokumentace + rychl√Ω tester")
    with st.expander("üìñ Demo API: JSONPlaceholder"):
        st.markdown("Base URL: https://jsonplaceholder.typicode.com  (nap≈ô. GET /todos/1)")
    colA, colB = st.columns([3, 1])
    with colA:
        url = st.text_input("URL endpointu", "https://jsonplaceholder.typicode.com/todos/1")
    with colB:
        metoda = st.selectbox("Metoda", ["GET", "POST", "PUT", "PATCH", "DELETE"])
    headers_text = st.text_area("HTTP headers (Kl√≠ƒç: Hodnota)", "Content-Type: application/json", height=80)
    body_text = st.text_area("Request JSON body", '{\\n  "title": "Test √∫kol",\\n  "completed": false\\n}', height=120)
    exp1, exp2 = st.columns(2)
    with exp1:
        expected_status = st.number_input("Oƒçek√°van√Ω status k√≥d", value=200, step=1)
    with exp2:
        validate_json = st.checkbox("Validovat JSON odpovƒõƒè", value=False)

    def parse_headers(text: str) -> dict:
        headers = {}
        for line in text.splitlines():
            if ":" in line:
                k, v = line.split(":", 1)
                headers[k.strip()] = v.strip()
        return headers

    def parse_json_or_none(text: str):
        try:
            return json.loads(text)
        except Exception:
            return None

    if st.button("Spustit dotaz"):
        headers = parse_headers(headers_text)
        json_body = parse_json_or_none(body_text)
        try:
            if metoda == "GET":
                r = requests.get(url, headers=headers, timeout=10)
            elif metoda == "POST":
                r = requests.post(url, headers=headers, json=json_body, timeout=10)
            elif metoda == "PUT":
                r = requests.put(url, headers=headers, json=json_body, timeout=10)
            elif metoda == "PATCH":
                r = requests.patch(url, headers=headers, json=json_body, timeout=10)
            elif metoda == "DELETE":
                r = requests.delete(url, headers=headers, timeout=10)
            else:
                r = None

            if r is not None:
                st.write("Status:", r.status_code)
                if r.headers.get("Content-Type", "").startswith("application/json"):
                    try:
                        st.json(r.json())
                    except Exception:
                        st.text(r.text[:2000])
                else:
                    st.text(r.text[:2000])

                if r.status_code == int(expected_status):
                    st.success(f"PASS ‚Äì status {r.status_code} = oƒçek√°van√Ω {expected_status}")
                else:
                    st.error(f"FAIL ‚Äì status {r.status_code} ‚â† oƒçek√°van√Ω {expected_status}")

                if validate_json:
                    try:
                        _ = r.json()
                        st.info("JSON odpovƒõƒè vypad√° validnƒõ.")
                    except Exception as e:
                        st.warning(f"JSON nelze naƒç√≠st: {e}")
        except Exception as e:
            st.error(f"Chyba p≈ôi vol√°n√≠ API: {e}")

# ---------- ROUTER ----------
if menu == "√övod":
    page_uvod()
elif menu == "Z√°klady":
    page_zaklady()
elif menu == "N√°stroje":
    page_nastroje()
elif menu == "Portfolio":
    page_portfolio()
elif menu == "Mini kv√≠z":
    page_kviz()
elif menu == "Timeline":
    page_timeline()
elif menu == "Zdroje":
    page_zdroje()
elif menu == "üìñ Teorie":
    page_teorie()
elif menu == "üß≠ QA tah√°k":
    page_qatahaky()
elif menu == "üåê API tester":
    page_api_tester()
